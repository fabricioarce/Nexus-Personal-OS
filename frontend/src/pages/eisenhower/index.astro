---
import Layout from "../../layouts/Layout.astro";
import Sidebar from "../../components/Sidebar.astro";
---

<Layout title="Matriz de Eisenhower - Decisiones">
    <div class="flex h-screen bg-background text-foreground overflow-hidden">
        <Sidebar />

        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header
                class="h-16 border-b border-border flex items-center justify-between px-8 bg-card/50 backdrop-blur-md"
            >
                <div class="flex items-center gap-4">
                    <h1
                        class="text-xl font-semibold bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent"
                    >
                        Gestor de Decisiones Eisenhower
                    </h1>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8">
                <div
                    class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8"
                >
                    <!-- Fast Entry Section -->
                    <div class="lg:col-span-1 space-y-6">
                        <section
                            class="bg-card border border-border rounded-2xl p-6 shadow-sm"
                        >
                            <h2
                                class="text-lg font-medium mb-4 flex items-center gap-2"
                            >
                                <span class="w-2 h-6 bg-purple-500 rounded-full"
                                ></span>
                                Entrada Rápida
                            </h2>
                            <form id="fast-entry-form" class="space-y-4">
                                <div>
                                    <label
                                        class="text-sm text-muted-foreground block mb-1"
                                        >Actividad</label
                                    >
                                    <input
                                        type="text"
                                        id="task-title"
                                        required
                                        placeholder="Ej. Planear viaje..."
                                        class="w-full bg-background border border-border rounded-xl px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                    />
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="text-sm text-muted-foreground block mb-1"
                                            >Urgencia (1-10)</label
                                        >
                                        <input
                                            type="number"
                                            id="task-urgency"
                                            min="1"
                                            max="10"
                                            value="5"
                                            class="w-full bg-background border border-border rounded-xl px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                        />
                                    </div>
                                    <div>
                                        <label
                                            class="text-sm text-muted-foreground block mb-1"
                                            >Importancia (1-10)</label
                                        >
                                        <input
                                            type="number"
                                            id="task-importance"
                                            min="1"
                                            max="10"
                                            value="5"
                                            class="w-full bg-background border border-border rounded-xl px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label
                                        class="text-sm text-muted-foreground block mb-1"
                                        >Notas</label
                                    >
                                    <textarea
                                        id="task-notes"
                                        rows="3"
                                        placeholder="Detalles adicionales..."
                                        class="w-full bg-background border border-border rounded-xl px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none transition-all resize-none"
                                    ></textarea>
                                </div>

                                <button
                                    type="submit"
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 rounded-xl transition-all shadow-lg shadow-purple-500/20 active:scale-[0.98]"
                                >
                                    Agregar Actividad
                                </button>
                            </form>
                        </section>

                        <!-- Task List (Mini) -->
                        <section
                            class="bg-card border border-border rounded-2xl p-6 shadow-sm overflow-hidden"
                        >
                            <h2 class="text-lg font-medium mb-4">
                                Actividades Recientes
                            </h2>
                            <div
                                id="recent-tasks-list"
                                class="space-y-3 max-h-[400px] overflow-y-auto pr-2"
                            >
                                <!-- Tasks will be injected here -->
                                <p class="text-sm text-muted-foreground italic">
                                    Cargando tareas...
                                </p>
                            </div>
                        </section>
                    </div>

                    <!-- Visualization Section -->
                    <div class="lg:col-span-2 space-y-6">
                        <section
                            class="bg-card border border-border rounded-3xl p-8 shadow-sm h-full flex flex-col min-h-[600px]"
                        >
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-semibold">
                                    Matriz de Prioridades
                                </h2>
                                <div class="flex gap-2 text-xs">
                                    <span
                                        class="px-2 py-1 rounded bg-red-500/10 text-red-500 border border-red-500/20"
                                        >Hacer</span
                                    >
                                    <span
                                        class="px-2 py-1 rounded bg-orange-500/10 text-orange-500 border border-orange-500/20"
                                        >Programar</span
                                    >
                                    <span
                                        class="px-2 py-1 rounded bg-blue-500/10 text-blue-500 border border-blue-500/20"
                                        >Delegar</span
                                    >
                                    <span
                                        class="px-2 py-1 rounded bg-slate-500/10 text-slate-500 border border-slate-500/20"
                                        >Eliminar</span
                                    >
                                </div>
                            </div>

                            <div class="flex-1 relative">
                                <canvas id="eisenhower-chart"></canvas>
                            </div>

                            <div
                                class="mt-4 grid grid-cols-2 text-[10px] text-muted-foreground uppercase tracking-widest text-center"
                            >
                                <div class="border-r border-border">
                                    Menos Urgente
                                </div>
                                <div>Más Urgente</div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </main>

        <!-- Task Detail Modal -->
        <div
            id="task-modal"
            class="fixed inset-0 bg-background/80 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300"
        >
            <div
                class="bg-card border border-border rounded-3xl p-8 w-full max-w-lg shadow-2xl transform scale-95 transition-transform duration-300"
            >
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span
                            id="modal-badge"
                            class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider mb-2 inline-block"
                            >Categoría</span
                        >
                        <h3 id="modal-title" class="text-2xl font-bold">
                            Título de la Tarea
                        </h3>
                    </div>
                    <button
                        id="close-modal"
                        class="p-2 hover:bg-accent rounded-full transition-colors"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24"
                            height="24"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><line x1="18" x2="6" y1="6" y2="18"></line><line
                                x1="6"
                                x2="18"
                                y1="6"
                                y2="18"></line></svg
                        >
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-accent/30 rounded-2xl p-4">
                            <label
                                class="text-xs text-muted-foreground mb-1 uppercase tracking-tighter block"
                            >
                                Urgencia
                            </label>
                            <input
                                type="number"
                                id="modal-urgency-input"
                                min="1"
                                max="10"
                                class="w-full bg-transparent text-xl font-semibold border-none focus:ring-0 p-0"
                            />
                        </div>
                        <div class="bg-accent/30 rounded-2xl p-4">
                            <label
                                class="text-xs text-muted-foreground mb-1 uppercase tracking-tighter block"
                            >
                                Importancia
                            </label>
                            <input
                                type="number"
                                id="modal-importance-input"
                                min="1"
                                max="10"
                                class="w-full bg-transparent text-xl font-semibold border-none focus:ring-0 p-0"
                            />
                        </div>
                    </div>

                    <div>
                        <p
                            class="text-xs text-muted-foreground mb-2 uppercase tracking-tighter"
                        >
                            Notas
                        </p>
                        <textarea
                            id="modal-notes-input"
                            rows="4"
                            class="w-full bg-background border border-border rounded-2xl p-4 text-sm text-foreground/90 resize-none focus:ring-2 focus:ring-purple-500 outline-none transition-all"
                        ></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button
                            id="update-task"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 rounded-xl transition-all"
                        >
                            Actualizar
                        </button>
                    </div>

                    <div class="flex gap-3 pt-2 border-t border-border">
                        <button
                            id="complete-task"
                            class="flex-1 bg-green-600/10 hover:bg-green-600 text-green-600 hover:text-white border border-green-600/20 font-medium py-2 rounded-xl transition-all text-sm"
                        >
                            Completar
                        </button>
                        <button
                            id="delete-task"
                            class="px-4 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/20 rounded-xl transition-all text-sm"
                        >
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import Chart from "chart.js/auto";

    let chart;
    let tasks = [];
    let selectedTaskId = null;

    async function fetchTasks() {
        try {
            const response = await fetch(
                "http://localhost:8000/api/eisenhower/",
            );
            tasks = await response.json();
            updateLayout();
        } catch (error) {
            console.error("Error fetching tasks:", error);
        }
    }

    function getCategory(urgency, importance) {
        if (urgency > 5 && importance > 5)
            return {
                name: "Hacer",
                class: "bg-red-500/10 text-red-500 border-red-500/20",
            };
        if (urgency <= 5 && importance > 5)
            return {
                name: "Programar",
                class: "bg-orange-500/10 text-orange-500 border-orange-500/20",
            };
        if (urgency > 5 && importance <= 5)
            return {
                name: "Delegar",
                class: "bg-blue-500/10 text-blue-500 border-blue-500/20",
            };
        return {
            name: "Eliminar",
            class: "bg-slate-500/10 text-slate-500 border-slate-500/20",
        };
    }

    function getColor(urgency, importance) {
        if (urgency > 5 && importance > 5) return "#ef4444"; // red
        if (urgency <= 5 && importance > 5) return "#f97316"; // orange
        if (urgency > 5 && importance <= 5) return "#3b82f6"; // blue
        return "#64748b"; // slate
    }

    function updateLayout() {
        renderChart();
        renderList();
    }

    function renderList() {
        const list = document.getElementById("recent-tasks-list");
        if (!list) return;

        if (tasks.length === 0) {
            list.innerHTML =
                '<p class="text-sm text-muted-foreground italic">No hay actividades pendientes.</p>';
            return;
        }

        list.innerHTML = tasks
            .slice(0, 5)
            .map((task) => {
                const cat = getCategory(task.urgency, task.importance);
                return `
        <div class="p-3 border border-border rounded-xl bg-background hover:bg-accent/30 cursor-pointer transition-colors task-item" data-id="${task.id}">
          <div class="flex justify-between items-start">
            <p class="text-sm font-medium truncate pr-2">${task.title}</p>
            <span class="text-[8px] px-1.5 py-0.5 rounded border ${cat.class}">${cat.name}</span>
          </div>
          <p class="text-[10px] text-muted-foreground mt-1">Urg: ${task.urgency} | Imp: ${task.importance}</p>
        </div>
      `;
            })
            .join("");

        document.querySelectorAll(".task-item").forEach((item) => {
            item.addEventListener("click", () =>
                openModal(parseInt(item.dataset.id)),
            );
        });
    }

    function renderChart() {
        const ctx = document
            .getElementById("eisenhower-chart")
            ?.getContext("2d");
        if (!ctx) return;

        if (chart) {
            chart.destroy();
        }

        const data = {
            datasets: [
                {
                    label: "Actividades",
                    data: tasks.map((t) => ({
                        x: t.urgency,
                        y: t.importance,
                        id: t.id,
                        title: t.title,
                    })),
                    backgroundColor: tasks.map((t) =>
                        getColor(t.urgency, t.importance),
                    ),
                    pointRadius: 10,
                    pointHoverRadius: 15,
                    pointBorderWidth: 2,
                    pointBorderColor: "#fff",
                },
            ],
        };

        chart = new Chart(ctx, {
            type: "scatter",
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e, items) => {
                    if (items.length > 0) {
                        const index = items[0].index;
                        const taskId = tasks[index].id;
                        openModal(taskId);
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: 11,
                        grid: {
                            display: false,
                        },
                        ticks: { display: false },
                    },
                    y: {
                        min: 0,
                        max: 11,
                        grid: {
                            display: false,
                        },
                        ticks: { display: false },
                    },
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => context.raw.title,
                        },
                    },
                },
            },
            plugins: [
                {
                    id: "matrixLabels",
                    beforeDraw: (chart) => {
                        const {
                            ctx,
                            chartArea: {
                                top,
                                bottom,
                                left,
                                right,
                                width,
                                height,
                            },
                            scales: { x, y },
                        } = chart;
                        ctx.save();

                        // Draw Central Cross
                        ctx.strokeStyle = "rgba(255,255,255,0.4)";
                        ctx.lineWidth = 2;

                        // Vertical line
                        const midX = x.getPixelForValue(5.5);
                        ctx.beginPath();
                        ctx.moveTo(midX, top);
                        ctx.lineTo(midX, bottom);
                        ctx.stroke();

                        // Horizontal line
                        const midY = y.getPixelForValue(5.5);
                        ctx.beginPath();
                        ctx.moveTo(left, midY);
                        ctx.lineTo(right, midY);
                        ctx.stroke();

                        // Draw Labels
                        ctx.font = "bold 14px sans-serif";
                        ctx.fillStyle = "rgba(255,255,255,0.3)";
                        ctx.textAlign = "center";

                        // Top-Left: PROGRAMAR (Low urgency, High importance)
                        ctx.fillText(
                            "PROGRAMAR",
                            left + width / 4,
                            top + height / 4,
                        );
                        // Top-Right: HACER (High urgency, High importance)
                        ctx.fillText(
                            "HACER",
                            left + (3 * width) / 4,
                            top + height / 4,
                        );
                        // Bottom-Left: ELIMINAR (Low urgency, Low importance)
                        ctx.fillText(
                            "ELIMINAR",
                            left + width / 4,
                            top + (3 * height) / 4,
                        );
                        // Bottom-Right: DELEGAR (High urgency, Low importance)
                        ctx.fillText(
                            "DELEGAR",
                            left + (3 * width) / 4,
                            top + (3 * height) / 4,
                        );

                        ctx.restore();
                    },
                },
            ],
        });
    }

    function openModal(taskId) {
        const task = tasks.find((t) => t.id === taskId);
        if (!task) return;

        selectedTaskId = taskId;
        const modal = document.getElementById("task-modal");
        const badge = document.getElementById("modal-badge");
        const cat = getCategory(task.urgency, task.importance);

        document.getElementById("modal-title").textContent = task.title;
        document.getElementById("modal-urgency-input").value = task.urgency;
        document.getElementById("modal-importance-input").value =
            task.importance;
        document.getElementById("modal-notes-input").value = task.notes || "";

        badge.textContent = cat.name;
        badge.className = `px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider mb-2 inline-block ${cat.class}`;

        modal.classList.remove("hidden");
        setTimeout(() => {
            modal.classList.remove("opacity-0");
            modal.querySelector("div").classList.remove("scale-95");
        }, 10);
    }

    function closeModal() {
        const modal = document.getElementById("task-modal");
        modal.classList.add("opacity-0");
        modal.querySelector("div").classList.add("scale-95");
        setTimeout(() => {
            modal.classList.add("hidden");
        }, 300);
    }

    // Event Listeners
    document
        .getElementById("fast-entry-form")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const title = document.getElementById("task-title").value;
            const urgency = parseInt(
                document.getElementById("task-urgency").value,
            );
            const importance = parseInt(
                document.getElementById("task-importance").value,
            );
            const notes = document.getElementById("task-notes").value;

            try {
                await fetch("http://localhost:8000/api/eisenhower/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title, urgency, importance, notes }),
                });
                document.getElementById("fast-entry-form").reset();
                await fetchTasks();
            } catch (error) {
                console.error("Error creating task:", error);
            }
        });

    document
        .getElementById("update-task")
        ?.addEventListener("click", async () => {
            if (!selectedTaskId) return;
            const urgency = parseInt(
                document.getElementById("modal-urgency-input").value,
            );
            const importance = parseInt(
                document.getElementById("modal-importance-input").value,
            );
            const notes = document.getElementById("modal-notes-input").value;

            try {
                await fetch(
                    `http://localhost:8000/api/eisenhower/${selectedTaskId}`,
                    {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ urgency, importance, notes }),
                    },
                );
                closeModal();
                await fetchTasks();
            } catch (error) {
                console.error("Error updating task:", error);
            }
        });

    document
        .getElementById("close-modal")
        ?.addEventListener("click", closeModal);

    document
        .getElementById("complete-task")
        ?.addEventListener("click", async () => {
            if (!selectedTaskId) return;
            try {
                await fetch(
                    `http://localhost:8000/api/eisenhower/${selectedTaskId}`,
                    {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ status: "completed" }),
                    },
                );
                closeModal();
                await fetchTasks();
            } catch (error) {
                console.error("Error completing task:", error);
            }
        });

    document
        .getElementById("delete-task")
        ?.addEventListener("click", async () => {
            if (!selectedTaskId) return;
            if (!confirm("¿Estás seguro de eliminar esta actividad?")) return;

            try {
                await fetch(
                    `http://localhost:8000/api/eisenhower/${selectedTaskId}`,
                    {
                        method: "DELETE",
                    },
                );
                closeModal();
                await fetchTasks();
            } catch (error) {
                console.error("Error deleting task:", error);
            }
        });

    // Initial load
    fetchTasks();
</script>

<style>
    #eisenhower-chart {
        width: 100% !important;
        height: 100% !important;
    }
</style>
